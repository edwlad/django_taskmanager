{% load poll_extras %}
{% if view.kwargs.oper == "edit" and view.kwargs.model == view.url_name %}
    {% firstof "edit" as oper %}
{% endif %}

<h2>Задача</h2>
<form action="" method="post" class="row mb-3">
{% for item in data %}
{% csrf_token %}
    {# Автор задачи #}
    <div class="col-2 text-end">
        {{view.fld.author.verbose_name}}
    </div>
    <div class="col" title="{{view.fld.author.help_text}}">
        {{ item.author.username }}
    </div>

    <div class="w-100"></div>

    {# Название задачи #}
    <div class="col-2 text-end" title="{{view.fld.name.help_text}}">
        <label class="{% if oper == "edit" %}fw-bold required{% endif %}" 
        for="id_{{ view.fld.name.name }}">
            {{view.fld.name.verbose_name}}
        </label>
    </div>
    <div class="col">
        {% if oper == "edit" %}
        <input class="form-control"
        type="text" 
        name="{{ view.fld.name.name }}"
        value="{{ item.name }}"
        maxlength="{{ view.fld.name.max_length }}" 
        required
        placeholder="{{view.fld.name.help_text}}"
        id="id_{{ view.fld.name.name }}">
    {% else %}
        {{ item.name }}
    {% endif %}    
    </div>

    <div class="w-100"></div>

    {# Описание задачи #}
    <div class="col-2 text-end mb-1">
        <label class="{% if oper == "edit" %}fw-bold required{% endif %}" 
            for="id_{{ view.fld.desc.name }}">
            {{view.fld.desc.verbose_name}}
        </label>
    </div>
    <div class="col mb-1" title="{{view.fld.desc.help_text}}">
    {% if oper == "edit" %}
        <textarea class="form-control"
        rows="3"
        type="text" 
        name="{{ view.fld.desc.name }}"
        required
        placeholder="{{view.fld.desc.help_text}}"
        id="id_{{ view.fld.desc.name }}">{{ item.desc }}</textarea>
    {% else %}
        {{ item.desc }}
    {% endif %}
     </div>

    <div class="w-100"></div>

    {# Проект задачи #}
    <div class="col-2 text-end mb-1">
        <label for="id_{{ view.fld.proj.name }}"
        onclick="alert('Клик');">
            {{view.fld.proj.verbose_name}}
        </label>
    </div>
    <div class="col mb-1" title="{{view.fld.proj.help_text}}">
    {% if oper == "edit" %}
        <select class="form-select form-select-sm"
        name="{{ view.fld.proj.name }}"
        id="id_{{ view.fld.proj.name }}"
        onchange="console.log('Выбор значения', this.value, this.text);"
        >
            <option value="" selected>-----</option>
        {% if item.proj %}
            <option value="{{ item.proj.id }}" selected>
                {{ item.proj.name }}
            </option>
        {% endif %}
        {% for pr in view.projs %}
            {% if item.proj.id != pr.id %}
            <option value="{{ pr.id }}">{{ pr.name }}</option>
            {% endif %}
        {% endfor %}
        </select>
    {% else %}
        {% if item.proj %}
            <a href={% url "detail" model=view.fld.proj.related_model.META.url_name pk=item.proj.id %}
            class="btn btn-light w-100 border-0 text-start"
            title="Перейти к проекту">
                {{ item.proj.name }}
            </a>
        {% else %}
            <span class="pe-none btn border-0">Нет</span>
        {% endif %}
    {% endif %}
    </div>

    <div class="w-100"></div>

    {# Спринт задачи #}
    <div class="col-2 text-end mb-1">
        <label for="id_{{ view.fld.sprint.name }}">
        {{view.fld.sprint.verbose_name}}
        </label>
    </div>
    <div class="col mb-1" title="{{view.fld.sprint.help_text}}">
    {% if oper == "edit" %}
        <select class="form-select form-select-sm"
        name="{{ view.fld.sprint.name }}"
        id="id_{{ view.fld.sprint.name }}">
            <option value="" selected>-----</option>
        {% if item.sprint %}
            <option value="{{ item.sprint.id }}" selected>
                {{ item.sprint.name }}
            </option>
        {% endif %}
        {% for pr in view.sprints %}
            {% if item.sprint.id != pr.id %}
            <option value="{{ pr.id }}">{{ pr.name }}</option>
            {% endif %}
        {% endfor %}
        </select>
    {% else %}
        {% if item.sprint %}
            <a href={% url "detail" model=view.fld.sprint.related_model.META.url_name pk=item.sprint.id %}
            class="btn btn-light w-100 border-0 text-start"
            title="Перейти к спринту">
                {{ item.sprint.name }}
            </a>
        {% else %}
                <span class="pe-none btn border-0">Нет</span>
        {% endif %}
    {% endif %}
    </div>

    <div class="w-100"></div>

    {#  #}
    <div class="col text-center border-end border-top">{{view.fld.user.verbose_name}}</div>
    {#  #}
    <div class="col text-center border-end border-top">{{view.fld.date_beg.verbose_name}}</div>
    {# дата завершения - название #}
    <div class="col-3 text-center border-end border-top">
        <label for="id_{{ view.fld.date_end.name }}">
        {{view.fld.date_end.verbose_name}}
        </label>
    </div>
    {# Планируемая дата - название #}
    <div class="col-3 text-center border-end border-top">
        <label for="id_{{ view.fld.date_max.name }}">План</label>
    </div>
    {#  #}
    <div class="col text-center border-top">Осталось дней</div>

    <div class="w-100"></div>

    {#  #}
    <div class="col text-center border-end" title="{{view.fld.user.help_text}}">{{ item.user.username }}</div>
    {#  #}
    <div class="col text-center border-end" title="{{view.fld.date_beg.help_text}}">{{ item.date_beg|date:"d.m.Y" }}</div>
    {# дата завершения - данные #}
    <div class="col-3 text-center border-end" title="{{view.fld.date_end.help_text}}">
    {% if oper == "edit" %}
        <input class="form-control"
        type="date" 
        name="{{ view.fld.date_end.name }}"
        value="{{ item.date_end|date:"Y-m-d" }}"
        id="id_{{ view.fld.date_end.name }}">
    {% else %}
        {{ item.date_end|date:"d.m.Y" }}
    {% endif %}
    </div>
    {# Планируемая дата - данные #}
    <div class="col-3 text-center border-end" title="{{view.fld.date_max.help_text}}">
    {% if oper == "edit" %}
        <input class="form-control"
        type="date" 
        name="{{ view.fld.date_max.name }}"
        value="{{ item.date_max|date:"Y-m-d" }}"
        id="id_{{ view.fld.date_max.name }}">
    {% else %}
    {{ item.date_plan|date:"d.m.Y" }}<br>
        <p style="font-size: 0.8rem;" class="lh-1 m-0 text-start">
            Минимальное из<br>
            Проект {{ item.proj.date_max|date:"d.m.Y" }}<br>
            Спринт {{ item.sprint.date_max|date:"d.m.Y" }}<br>
            Задача {{ item.date_max|date:"d.m.Y" }}
        </p>
    {% endif %}
    </div>
    {#  #}
    <div class="col text-center">
        {% if item.date_end %}
        Завершено
        {% else %}
        {{ item.days_plan.days }}
        {% endif %}
    </div>

    <div class="w-100"></div>

    {% if oper == "edit" %}
    <div class="col d-flex justify-content-end align-items-center mb-1 mt-2">
        <div class="me-2">
        {% include "buttons.html" with btn_max="cancel" model=view.url_name pk=item.id %}
        </div>
        <input type="submit" value="Сохранить" class="btn btn-success">
    </div>
    <div class="w-100"></div>
    {% endif %}

    <div class="col">
        {% include "buttons.html" with btn_max="back add edit delete" model=view.url_name pk=item.id %}
    </div>
{% empty %}
    <div class="col">
        Нет задачи
        {% include "buttons.html" with btn_max="back add" model=view.url_name %}
    </div>
{% endfor %}
</form>

<hr>

